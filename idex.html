<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Custom Collage Generator</title>
  <style>
    body {
      font-family: sans-serif;
      background: #6a5acd;
      color: white;
      padding: 20px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-size: 14px;
      margin-bottom: 3px;
    }
    input, select, button {
      padding: 5px;
      font-size: 14px;
    }
    canvas {
      background: white;
      display: block;
      margin-top: 20px;
      max-width: 100%;
    }
  </style>
</head>
<body>

  <h1>Collage Generator</h1>
  <div class="controls">
    <div>
      <label>Choose images</label>
      <input type="file" id="fileInput" multiple accept="image/*">
    </div>

    <div>
      <label>Columns</label>
      <input type="number" id="columns" value="4" min="1" max="10">
    </div>

    <div>
      <label>Filename (without .jpg)</label>
      <input type="text" id="filename" value="collage">
    </div>

    <div style="align-self: flex-end;">
      <button id="generateBtn">Generate</button>
      <button id="downloadBtn" disabled>Download JPG</button>
    </div>
  </div>

  <canvas id="canvas"></canvas>

<script>
const fileInput = document.getElementById('fileInput');
const columnsInput = document.getElementById('columns');
const filenameInput = document.getElementById('filename');
const generateBtn = document.getElementById('generateBtn');
const downloadBtn = document.getElementById('downloadBtn');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let images = [];
let dataURL = '';

fileInput.addEventListener('change', () => {
  const files = Array.from(fileInput.files);
  images = [];
  let loaded = 0;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        images.push(img);
        loaded++;
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
});

generateBtn.addEventListener('click', () => {
  if (images.length === 0) {
    alert('Please select some images first.');
    return;
  }

  const cols = parseInt(columnsInput.value);
  const gap = 2;
  const cellH = 200; // fixed height for all rows
  const rows = Math.ceil(images.length / cols);

  // Calculate total canvas width
  const fullRowWidth = cols * cellH + (cols - 1) * gap;
  canvas.height = rows * cellH + (rows - 1) * gap;
  canvas.width = fullRowWidth;

  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  let idx = 0;
  for (let r = 0; r < rows; r++) {
    const isLastRow = (r === rows - 1);
    let imagesInRow = isLastRow ? (images.length - idx) : cols;
    let cellW = isLastRow && imagesInRow < cols 
                  ? (canvas.width - (imagesInRow - 1) * gap) / imagesInRow
                  : (canvas.width - (cols - 1) * gap) / cols;

    for (let c = 0; c < imagesInRow; c++) {
      if (idx >= images.length) break;
      const img = images[idx];
      const x = c * (cellW + gap);
      const y = r * (cellH + gap);

      // Scale to fit
      const scale = Math.min(cellW / img.width, cellH / img.height);
      const drawW = img.width * scale;
      const drawH = img.height * scale;
      const offsetX = x + (cellW - drawW) / 2;
      const offsetY = y + (cellH - drawH) / 2;

      ctx.drawImage(img, offsetX, offsetY, drawW, drawH);
      idx++;
    }
  }

  dataURL = canvas.toDataURL('image/jpeg', 0.95);
  downloadBtn.disabled = false;
});

downloadBtn.addEventListener('click', () => {
  let filename = filenameInput.value.trim() || 'collage';
  if (!filename.toLowerCase().endsWith('.jpg')) {
    filename += '.jpg';
  }
  const a = document.createElement('a');
  a.href = dataURL;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
});
</script>

</body>
</html>
